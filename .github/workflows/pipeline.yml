name: Reusable Workflow

env:
  MAVEN_VERSION: '3.9.12'
  # Cloud storage environment variables (available to all jobs that need them)
  ## AWS
  AWS_S3_HOST: ${{ secrets.AWS_S3_HOST }}
  AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
  AWS_S3_REGION: ${{ secrets.AWS_S3_REGION }}
  AWS_S3_ACCESS_KEY_ID: ${{ secrets.AWS_S3_ACCESS_KEY_ID }}
  AWS_S3_SECRET_ACCESS_KEY: ${{ secrets.AWS_S3_SECRET_ACCESS_KEY }}
  ## Azure
  AZURE_CONTAINER_URI: ${{ secrets.AZURE_CONTAINER_URI }}
  AZURE_SAS_TOKEN: ${{ secrets.AZURE_SAS_TOKEN }}
  ## GCP
  GS_BASE_64_ENCODED_PRIVATE_KEY_DATA: ${{ secrets.GS_BASE_64_ENCODED_PRIVATE_KEY_DATA }}
  GS_BUCKET: ${{ secrets.GS_BUCKET }}
  GS_PROJECT_ID: ${{ secrets.GS_PROJECT_ID }}

on:
  workflow_call:
    inputs:
      deploy-snapshot:
        required: true
        type: boolean
        default: false

jobs:
  build:
    name: Build (Java ${{ matrix.java-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        java-version: [ 17, 21 ]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Spotless check
        run: mvn spotless:check -Dspotless.check.skip=false

      - name: Build
        uses: ./.github/actions/build
        with:
          java-version: ${{ matrix.java-version }}
          maven-version: ${{ env.MAVEN_VERSION }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-artifacts-java-${{ matrix.java-version }}
          path: |
            **/target/*.jar
            **/pom.xml
            .mvn/
          retention-days: 1

  integration-tests:
    name: Integration Tests (Java ${{ matrix.java-version }}, ${{ matrix.test-type }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build
    strategy:
      matrix:
        java-version: [ 17, 21 ]
        test-type: [ build-version, latest-version, oss ]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-artifacts-java-${{ matrix.java-version }}

      - name: Integration Tests
        uses: ./.github/actions/integration-tests
        with:
          java-version: ${{ matrix.java-version }}
          maven-version: ${{ env.MAVEN_VERSION }}
          test-type: ${{ matrix.test-type }}

  sonarqube-scan:
    name: SonarQube Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: SonarQube Scan
        uses: ./.github/actions/scan-with-sonar
        with:
          java-version: 17
          maven-version: ${{ env.MAVEN_VERSION }}
          sonarq-token: ${{ secrets.SONARQ_TOKEN }}
          github-token: ${{ secrets.GH_TOKEN }}

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 30
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'sapmachine'
          cache: 'maven'

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java-kotlin
          build-mode: manual

      - name: Build Java code
        run: mvn clean compile -DskipTests -B -ntp

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:java-kotlin"

  deploy-snapshot:
    name: Deploy snapshot to Artifactory
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ inputs.deploy-snapshot == true }}
    needs: [build, integration-tests, codeql]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'sapmachine'
          cache: 'maven'
          server-id: artifactory
          server-username: DEPLOYMENT_USER
          server-password: DEPLOYMENT_PASS

      - name: Set up Maven ${{ env.MAVEN_VERSION }}
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: ${{ env.MAVEN_VERSION }}

      - name: Set Dry Run for Pull Request
        if: github.event_name == 'pull_request_target'
        run: echo "DRY_RUN_PARAM=-DaltDeploymentRepository=local-repo::default::file:./local-repo" >> $GITHUB_ENV
        shell: bash

      - name: Get Revision
        id: get-revision
        run: |
          echo "REVISION=$(mvn help:evaluate -Dexpression=revision -q -DforceStdout)" >> $GITHUB_OUTPUT
        shell: bash

      - name: Print Revision
        run: echo "Current revision ${{ steps.get-revision.outputs.REVISION }}"
        shell: bash

      - name: Deploy snapshot
        if: ${{ endsWith(steps.get-revision.outputs.REVISION, '-SNAPSHOT') }}
        run: mvn -B -ntp -fae -pl !integration-tests,!integration-tests/db,!integration-tests/srv -Dmaven.install.skip=true -Dmaven.test.skip=true -DdeployAtEnd=true deploy
        env:
          DEPLOYMENT_USER: ${{ secrets.DEPLOYMENT_USER }}
          DEPLOYMENT_PASS: ${{ secrets.DEPLOYMENT_PASS }}
        shell: bash
