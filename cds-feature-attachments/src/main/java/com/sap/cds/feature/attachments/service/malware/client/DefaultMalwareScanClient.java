/**************************************************************************
 * (C) 2019-2024 SAP SE or an SAP affiliate company. All rights reserved. *
 **************************************************************************/
package com.sap.cds.feature.attachments.service.malware.client;

import java.io.IOException;
import java.io.InputStream;
import java.util.Objects;

import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpEntityEnclosingRequestBase;
import org.apache.http.entity.InputStreamEntity;
import org.apache.http.util.EntityUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.Marker;

import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.sap.cds.feature.attachments.service.malware.client.httpclient.HttpClientProviderFactory;
import com.sap.cds.feature.attachments.service.malware.client.model.MalwareScanResult;
import com.sap.cds.feature.attachments.service.malware.client.model.MalwareScanResultStatus;
import com.sap.cds.feature.attachments.utilities.LoggingMarker;
import com.sap.cds.integration.cloudsdk.rest.client.JsonRestClientResponseException;
import com.sap.cds.services.ServiceException;

/**
 * Default implementation of the {@link MalwareScanClient} interface.
 * The given input stream is scanned by using the malware scan service.
 * The result of the scan is returned with status {@link MalwareScanResultStatus}.
 */
public class DefaultMalwareScanClient implements MalwareScanClient {

	private static final String JSON_CONTENT = "application/json";

	private static final Logger logger = LoggerFactory.getLogger(DefaultMalwareScanClient.class);
	private static final Marker marker = LoggingMarker.MALWARE_SCANNER.getMarker();

	private final ObjectMapper mapper = buildObjectMapper();
	private final HttpClientProviderFactory clientProviderFactory;

	public DefaultMalwareScanClient(HttpClientProviderFactory clientProviderFactory) {
		this.clientProviderFactory = clientProviderFactory;
	}

	private static ObjectMapper buildObjectMapper() {
		ObjectMapper mapper = new ObjectMapper();
		mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
		return mapper;
	}

	@Override
	public MalwareScanResultStatus scanContent(InputStream content) {
		if (!clientProviderFactory.isServiceBound()) {
			logger.warn(marker, "No malware scanner service bound, never use this in productive environment!");
			return MalwareScanResultStatus.NO_SCANNER;
		} else {
			logger.info(marker, "Start scanning document");
			return scanContentWithClient(content);
		}
	}

	private MalwareScanResultStatus scanContentWithClient(InputStream content) {
		var httpClient = clientProviderFactory.getHttpClientProvider().get();
		var request = buildHttpRequest(content);
		return executeRequest(httpClient, request);
	}

	private HttpEntityEnclosingRequestBase buildHttpRequest(InputStream content) {
		InputStreamEntity reqEntity = new InputStreamEntity(content, -1);
		reqEntity.setContentType("binary/octet-stream");
		reqEntity.setChunked(true);

		var request = new HttpEntityEnclosingRequestBase() {
			@Override
			public String getMethod() {
				return "POST";
			}
		};
		request.setEntity(reqEntity);
		return request;
	}

	private MalwareScanResultStatus executeRequest(HttpClient httpClient, HttpEntityEnclosingRequestBase request) {
		try (var response = (CloseableHttpResponse) httpClient.execute(request)) {
			var malwareScanResult = convertHttpResponseToJavaObject(response);
			return mapResponseToStatus(malwareScanResult);
		} catch (IOException e) {
			throw new ServiceException(e);
		}
	}

	private MalwareScanResult convertHttpResponseToJavaObject(CloseableHttpResponse response) throws IOException {
		int code = response.getStatusLine().getStatusCode();

		logger.debug("Server responded with status code '{}'", code);

		if (code >= 200 && code <= 207) {
			String contentType = JSON_CONTENT;
			if (response.getEntity() != null) {
				if (Objects.nonNull(response.getEntity().getContentType())) {
					contentType = response.getEntity().getContentType().getValue();
				}
				if (contentType.contains(JSON_CONTENT)) {
					String jsonData = EntityUtils.toString(response.getEntity());
					return mapper.readValue(jsonData, MalwareScanResult.class);
				} else {
					throw new IOException("Unexpected response format: Expected JSON but found '" + contentType + "'");
				}
			} else {
				return mapper.readValue("{}", MalwareScanResult.class);
			}
		} else {
			String reason = response.getStatusLine().getReasonPhrase();
			throw new JsonRestClientResponseException(code, "Unexpected request HTTP response (" + code + ") " + reason);
		}
	}

	private MalwareScanResultStatus mapResponseToStatus(MalwareScanResult responseJson) {
		if (responseJson.isMalwareDetected() || responseJson.isEncryptedContentDetected()) {
			logger.warn(
					"Document is infected with malware, response status from scan was: malwareDetected = {}, encryptedContentDetected = {}",
					responseJson.isMalwareDetected(), responseJson.isEncryptedContentDetected());
			return MalwareScanResultStatus.INFECTED;
		} else {
			logger.info("Document is clean");
			return MalwareScanResultStatus.CLEAN;
		}
	}

}
