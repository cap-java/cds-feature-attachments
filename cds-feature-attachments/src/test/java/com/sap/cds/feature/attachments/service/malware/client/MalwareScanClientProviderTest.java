/*
 * Â© 2024-2025 SAP SE or an SAP affiliate company and cds-feature-attachments contributors.
 */
package com.sap.cds.feature.attachments.service.malware.client;

import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

import com.sap.cds.services.environment.CdsProperties;
import com.sap.cds.services.environment.CdsProperties.ConnectionPool;
import com.sap.cds.services.request.UserInfo;
import com.sap.cds.services.runtime.CdsRuntime;
import com.sap.cloud.environment.servicebinding.api.ServiceBinding;
import java.util.Map;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

class MalwareScanClientProviderTest {
  private ServiceBinding binding;
  private ConnectionPool connectionPoolConfig;

  @BeforeEach
  void setup() {
    binding = mock(ServiceBinding.class);
    connectionPoolConfig = mock(ConnectionPool.class);
  }

  @Test
  void clientProviderReturned() {
    mockInput();
    when(connectionPoolConfig.getMaxConnections()).thenReturn(10);
    when(connectionPoolConfig.getMaxConnectionsPerRoute()).thenReturn(1);

    var cut = new MalwareScanClientProvider(binding, connectionPoolConfig);

    var client = cut.getHttpClient();
    assertNotNull(client);
  }

  private void mockInput() {
    Map<String, Object> credentials =
        Map.of("username", "name", "password", "pass", "url", "http://localhost:8080");
    when(binding.getCredentials()).thenReturn(credentials);
    var enabled = mock(CdsProperties.Enabled.class);
    when(connectionPoolConfig.getCombinePools()).thenReturn(enabled);
    when(connectionPoolConfig.getMaxConnections()).thenReturn(20);
    when(connectionPoolConfig.getMaxConnectionsPerRoute()).thenReturn(20);
  }
}
